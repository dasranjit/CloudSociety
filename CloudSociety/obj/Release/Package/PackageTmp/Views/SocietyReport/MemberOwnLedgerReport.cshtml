@model IEnumerable<CloudSocietyEntities.MemberLedger>
@{
    ViewBag.Title = "Member Ledger Report";
    ViewBag.Header = "Member Ledger Report";
    ViewBag.SocietyNameHeader = ViewBag.SocietyHead;
    Layout = "~/Views/Shared/SocietyLayout.cshtml";
    string date = "";
    decimal RecAmoutTd;
    decimal BillAmoutTd;
    decimal TotalBillAmountTd = 0;
    decimal TotalRecAmountTd = 0;
    decimal BalanceTd = 0;
    bool IsBill = false;
    string BillAmount = "";
    string ReceiptAmount = "";
    string BalanceAmount = "";
    string memberName = ViewBag.MemberName != null ? ViewBag.MemberName : "MEMBER";

}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
<script type="text/javascript">
    function showPaymentDetais() {
        document.getElementById("divLedgerDetails").style.display = 'none';
        document.getElementById("divPaymentDetails").style.display = 'block';
    }
    function hidePaymentDetais() {
        document.getElementById("divLedgerDetails").style.display = 'block';
        document.getElementById("divPaymentDetails").style.display = 'none';
    }
    function isNumberKey(evt) {
        var charCode = (evt.which) ? evt.which : evt.keyCode;
        if (charCode != 46 && charCode > 31
          && (charCode < 48 || charCode > 57))
            return false;

        return true;
    }
    function validate() {
        value = document.getElementById("txtPayingAmt").value;
        if (value <= 0) {
            document.getElementById("spnError").style.display = 'block';
            return false;
        } else {
            document.getElementById("spnError").style.display = 'none';
            return true;
        }
    }
    function ProceedToPay() {
        value = document.getElementById("txtPayingAmt").value;
        if (value <= 0) {
            document.getElementById("spnError").style.display = 'block';
            return false;
        } else {
            document.getElementById("spnError").style.display = 'none';
        }
        $("#divLoading").show();
        $.post("/SocietyReport/ProcessPayment", { PayingAmt: value }, function (response) {
            if (response=="true") {
                $("#divPaymentDetails").html("<h3>Your payment done successfully.</h3>")
            }
            $("#divLoading").hide();
        });
    }
</script>

<div id="divLedgerDetails">
    <span class="SocName">@memberName's LEDGER AS ON @ViewBag.AsOn </span>
    <br />
    <br />
    <table border="0" cellpadding="2" cellspacing="0" class="table">
        @{
            int Count = 1;
        }
        @foreach (var item in Model)
        {
            if (Count == 1)
            {
            <tr>
                <th style="text-align: center">DocNo </th>
                <th style="text-align: center">DocDate </th>
                <th style="width: 350px; text-align: center">Particulars </th>
                <th style="text-align: right">Bill Amount(Dr)</th>
                <th style="text-align: right">Receipt Amount(Cr) </th>
                <th style="text-align: right">Balance Amount</th>
            </tr>
            }
            <tr @if ((Count % 2) == 0)
                { <text> class="TableRow" </text>  }
                else
                { <text> class="altTableRow" </text> }>
                <td>@item.BillNo</td>
                <td>
                    @{date = item.BillDate != null ? String.Format("{0:dd-MMM-yy}", item.BillDate) : "";}
                    @date
                </td>
                <td>
                    @item.Particulars
                </td>
                <td style="text-align: right">
                    @{
                      IsBill = item.BillNo != "" ? item.BillNo.Substring(0, 1) == "B" || item.BillNo.Substring(0, 1) == "V" : false;
                      BillAmoutTd = 0;
                      RecAmoutTd = 0;
                      BillAmoutTd = IsBill ? ((item.ChgAmt ?? 0) + (item.NonChgAmt ?? 0) + (item.IntAmt ?? 0) + (item.TaxAmt ?? 0) - (item.Advance ?? 0)) : 0;
                      TotalBillAmountTd += BillAmoutTd;
                      RecAmoutTd = (!IsBill && item.BillNo != "") ? ((item.ChgAmt ?? 0) + (item.NonChgAmt ?? 0) + (item.IntAmt ?? 0) + (item.TaxAmt ?? 0) + (item.Advance ?? 0)) : 0;
                      TotalRecAmountTd += RecAmoutTd;
                      BalanceTd += ((item.ChgBal ?? 0) + (item.NonChgBal ?? 0) + (item.IntBal ?? 0) + (item.TaxBal ?? 0) - (item.AdvBal ?? 0));
                      BillAmount = BillAmoutTd == 0 ? "-" : BillAmoutTd.ToString();
                      ReceiptAmount = RecAmoutTd == 0 ? "-" : RecAmoutTd.ToString();
                      BalanceAmount = BalanceTd < 0 ? Math.Abs(BalanceTd) + " Cr" : (BalanceTd == 0 ? BalanceTd + "" : BalanceTd + " Dr");
                    }
                    @BillAmount
                </td>
                <td style="text-align: right">@ReceiptAmount</td>
                <td style="text-align: right">@BalanceAmount</td>
            </tr>
                      Count = Count + 1;
        }
        @if (Count == 1)
        {
            <tr class="TableRow">
                <td>Currently there are no Records</td>
            </tr> 
        }
        else
        {
            <tr>
                <td colspan="3" style="text-align: right; font-weight: bold;">Member Total :</td>
                <td style="text-align: right; font-weight: bold;">@TotalBillAmountTd</td>
                <td style="text-align: right; font-weight: bold;">@TotalRecAmountTd</td>
                <td></td>
            </tr>
        }
    </table>
    <br />
    @if (Count > 1)
    {
        <div>
            @Html.ActionLink("Download PDF", "MemberOwnLedgerReport", new { id = ViewBag.SocietySubscriptionID, IsToDownLoad = true }, new { @class = "buttton", @style = "color: white !important; width: 75px;" })
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
   @if (ViewBag.ShowPaymentLink)
   { 
       <input type="button" value="Pay by Gateway" onclick="showPaymentDetais()" class="buttton" style="color: white !important; width: 105px;" />
   }
        </div>
    }
</div>
<br />
<div id="divPaymentDetails" style="display: none;">
    <h3>Total Payable Amount (with interest charges till date) is &#8377 @(TotalBillAmountTd - TotalRecAmountTd) </h3>
    <table>
        <tr>
            <td colspan="3"></td>
        </tr>
        <tr>
            <td class="editor-label">Paying Amount </td>
            <td>:</td>
            <td class="editor-field">
                <input type="text" id="txtPayingAmt" name="PayingAmt" onblur="validate()" onkeypress="return isNumberKey(event)" value="@(TotalBillAmountTd - TotalRecAmountTd)" />
                <span id="spnError" style="display: none; color: red; margin-bottom: -14px;">Please enter valid amount.</span>
            </td>
        </tr>
        <tr>
            <td colspan="3" align="center">&nbsp;</td>
        </tr>
        <tr>
            <td colspan="3" align="center">
                <input type="button" value="Cancel" onclick="hidePaymentDetais()" class="buttton" style="color: white !important; width: 85px;" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <input type="button" value="Proceed To Pay" class="buttton" style="color: white !important; width: 105px;" onclick="ProceedToPay()" />
            </td>
        </tr>
    </table>
</div>
<div id="divLoading" style="display:none; margin-left: 170px;">
    <div class="loader"></div>
    <span>Please wait..</span>
</div>
