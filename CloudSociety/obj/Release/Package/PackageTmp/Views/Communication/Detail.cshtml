@model CloudSocietyEntities.Communication
@{
    ViewBag.Title = "View Message";
    bool myMessage = (bool)ViewBag.MyMessage;
    CloudSocietyEntities.CommunicationType objCommunicationType = ViewBag.CommunicationType;
    //var entity = (CloudSocietyEntities.Communication)ViewBag.Message;
    //var ct = entity.CommunicationType.CommunicationType1;
    var communicationId = Model.CommunicationID;
    var replyList = (IEnumerable<CloudSocietyEntities.CommunicationReply>)ViewBag.replies;
    var header = String.Concat(myMessage ? "My " : "Incoming ", objCommunicationType != null ? objCommunicationType.CommunicationType1 : "", " Message");
    ViewBag.Header = header;
    ViewBag.SocietyNameHeader = ViewBag.SocietyHead;
    Layout = "~/Views/Shared/SocietyLayout.cshtml";
    bool IsFullAccess = new CloudSociety.Controllers.AppInfoController().IsFullAccess();
    
}
<script type="text/javascript">
    function setSendAndClose() {
        document.getElementById("IsToClose").value = true;
    }
</script>
<legend>@header</legend>
<table style="width: 100%">
    <tr class="TableRow">
        <td>
            <table>
                <tr>
                    <td><b>Ticket#:</b>&nbsp;&nbsp;@String.Format("{0:000000}", Model.TicketNumber)</td>
                    <td><b>Sent On:</b>&nbsp;&nbsp;@string.Format("{0:dd-MMM-yyyy HH:MM}", Model.UpdatedOn)</td>
                    @if (!string.IsNullOrWhiteSpace(Model.ApprovedByWithUnit))
                    {
                        <td><b>Approved By:</b>&nbsp;&nbsp;@Model.ApprovedByWithUnit</td>
                        <td><b>Approved On:</b>&nbsp;&nbsp;@string.Format("{0:dd-MMM-yyyy HH:MM}", Model.ApprovedOn.Value)</td> 
                    }
                </tr>
            </table>
        </td>
        <td>
            @if (!myMessage)
            {
@*@Html.Display("By :&nbsp;&nbsp;");*@
                <span><b>By:</b>&nbsp;&nbsp;</span> 
                @Model.SocietyMember.Member;
            }
            &nbsp;
        </td>
    </tr>
    <tr class="TableRow">
        <td colspan="2"><b>To:</b>
            @if (!string.IsNullOrEmpty(ViewBag.FilePath) && !string.IsNullOrEmpty(ViewBag.FileName))
            {
                @Html.Hidden("hdnEditFilePath", (string)ViewBag.FilePath)
                @Html.Hidden("hdnEditFileName", (string)ViewBag.FileName)
                <span style="float: right;">@Html.Partial("PVDisplayFileContains")</span>
            }
            else
            {
                <span style="float: right;">&nbsp;</span>
            }
        </td>
    </tr>
    <tr>
        <td colspan="2">
            <div style="height: 110px; overflow-y: scroll;">
                @Html.Raw(HttpUtility.HtmlDecode(ViewBag.recipients))
            </div>
        </td>
    </tr>
    <tr>
        <td colspan="2" class="TableRow"><b>Subject :</b>&nbsp; &nbsp;
            @Model.Subject
        </td>
    </tr>
    <tr class="TableRow">
        <td colspan="2">
            @Model.Details
        </td>
    </tr>
    <tr>
        <td colspan="2">
            <hr />
        </td>
    </tr>
</table>
<br />
@if (Model.Replies > 0)
{ 
    <legend>Replies</legend>
    <table border="0" cellpadding="2" cellspacing="0" class="table">
        @foreach (var item in replyList)
        {
            <tr class="TableRow">
                <td>
                    @String.Format("{0:dd-MMM-yyyy HH:MM}", item.CreatedOn)
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        @item.SocietyMember.Member
                    <br />
                    <br />
                    @item.Reply
                </td>
            </tr>
        }
    </table>

    <br />
}
@if (objCommunicationType != null && !Model.Closed)
{
    if (!objCommunicationType.OnlyForOfficeBearer)
    {
        using (Html.BeginForm())
        {
    <legend>Reply</legend>
    @Html.Hidden("myMessage", myMessage)
    @Html.Hidden("CommunicationID", (Guid)communicationId)
    @Html.ValidationSummary(false, "Following errors occurred while processing your request")
    <fieldset style="width: 900px">
        <table>
            <tr>
                <td>
                    @Html.TextArea("Reply", "", 6, 90, new { @class = "width800" })
                </td>
            </tr>
            @if (Roles.IsUserInRole(Membership.GetUser().UserName, "OfficeBearer") ||
                    (Model.Society.SocietyCommunicationSettings.FirstOrDefault().AllowToSendSmsAndEmailForGD &&
                    Model.CommunicationType.CommunicationType1.Trim().ToUpper() == "GROUP DISCUSSION"))
            {
                <tr>
                    <td>
                        <table>
                            <tr>
                                @if (ViewBag.ShowEmailAndSms)
                                {
                                    <td>&nbsp;</td>
                                    <td>@Html.CheckBox("SendSMS", true) Send SMS</td>
                                    <td>&nbsp;</td>
                                    <td>@Html.CheckBox("SendEmail", true) Send Email</td>
                                }
                                else
                                {
                                    @Html.Hidden("SendSMS", false)
                                    @Html.Hidden("SendEmail", false)
                                }
                            </tr>
                        </table>
                    </td>
                </tr>
            }
            else
            {
                @Html.Hidden("SendSMS", false)
                @Html.Hidden("SendEmail", false)
            }
            @Html.Hidden("IsToClose", false)
            @if (IsFullAccess)
            {
                <tr>
                    <td align="center">
                        <input type="submit" value="Send" class="buttton" style="width: 45px; height: 23px;" />
                        @if (Model.ShowClose)
                        {
                            <text>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</text><input type="submit" value="Send And Close" class="buttton" onclick="setSendAndClose()" style="width: 89px; height: 23px;" />
                        }
                    </td>
                </tr>
            }
        </table>
    </fieldset>
        }
    }
}
@if (Model.Closed)
{
  <center>  <input type="submit" value="Communication Closed" class="buttton" disabled="disabled" style="width: 126px; height: 23px;" /></center>
}
<br />
@Html.Hidden("id", (Guid)ViewBag.id)

@Html.ActionLink("Back to List", "Index", new { id = (Guid)ViewBag.id }, new { @class = "EditDelete" })

